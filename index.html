<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ship Royale ‚Äî Last Ship Standing</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a1a">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P" rel="stylesheet">
    <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #0a0a1a; font-family: 'Press Start 2P', monospace; }
        canvas { display: block; }
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a1a; z-index: 9999; transition: opacity 0.5s;
            display: flex; align-items: center; justify-content: center;
        }
        #splash img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #splash.fade { opacity: 0; }
        #splash { cursor: pointer; }
        #splash-tap {
            position: absolute; bottom: 15%; left: 0; width: 100%; text-align: center;
            font-family: 'Press Start 2P', monospace; font-size: 14px; color: #fff;
            text-shadow: 0 0 10px #000, 0 0 20px #000; transition: opacity 0.2s;
        }
        .nes-container, .nes-btn, .nes-input { font-family: 'Press Start 2P', monospace; }
        .nes-container.is-dark { background: rgba(0,0,0,0.8); border-color: #555; }
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7);
        }
        #start-screen.hidden { display: none; }
        #start-screen .panel { max-width: 340px; width: 90%; padding: 16px 12px; text-align: center; }
        #start-screen .title { color: #ffcc00; font-size: 14px; margin-bottom: 4px; text-shadow: 0 0 8px #ff8800; }
        #start-screen .subtitle { color: #aaa; font-size: 8px; margin-bottom: 12px; }
        #start-screen .legend { text-align: left; margin-bottom: 10px; }
        #start-screen .legend-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        #start-screen .legend-row img { width: 24px; height: 24px; image-rendering: pixelated; }
        #start-screen .legend-row span { color: #fff; font-size: 7px; }
        #start-screen .hint { color: #aaa; font-size: 7px; margin-bottom: 14px; line-height: 1.6; }
        #start-screen .btn-row { margin-bottom: 8px; }
        #start-screen .btn-row button { font-size: 9px; }
        #start-screen #start-name-btn { font-size: 8px; color: #aaa; background: transparent; border: 1px solid #555; cursor: pointer; padding: 4px 8px; margin-top: 4px; }
        #hud {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none; display: none;
        }
        #hud.show { display: block; }
        #hud-stats {
            position: absolute; top: 8px; left: 8px;
            padding: 6px 10px; pointer-events: auto;
            font-size: 8px; line-height: 1.8;
        }
        #hud-hp { color: #00ff00; }
        #hud-alive { color: #ccc; }
        #hud-xp { color: #ffcc00; }
        #hud-zone { color: #ff88ff; }
        #hud-actions {
            position: absolute; bottom: 16px; left: 16px;
            display: flex; gap: 12px; pointer-events: auto;
        }
        .action-btn {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            background: rgba(0,0,0,0.6); border: 2px solid #555; border-radius: 6px;
            padding: 6px; pointer-events: auto;
        }
        .action-btn img { width: 48px; height: 48px; image-rendering: pixelated; }
        .action-btn .count { color: #fff; font-size: 8px; margin-top: 2px; font-family: 'Press Start 2P', monospace; }
        .action-btn.disabled { opacity: 0.4; }
        #hud-buffs {
            position: absolute; bottom: 16px; right: 16px;
            display: flex; flex-direction: column; gap: 6px; align-items: center;
            pointer-events: none;
        }
        .buff-icon { display: none; text-align: center; }
        .buff-icon.active { display: block; }
        .buff-icon img { width: 32px; height: 32px; image-rendering: pixelated; }
        .buff-icon .timer { color: #44aaff; font-size: 8px; font-family: 'Press Start 2P', monospace; }
        #buff-cannon .timer { color: #ffaa00; }
        #end-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500; display: none; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.8);
        }
        #end-screen.show { display: flex; }
        #end-screen .panel { max-width: 340px; width: 90%; padding: 16px 12px; text-align: center; }
        #end-screen .end-title { color: #ffcc00; font-size: 14px; margin-bottom: 12px; text-shadow: 0 0 8px #ff8800; }
        #end-screen .end-stats { color: #fff; font-size: 8px; line-height: 2; margin-bottom: 14px; }
        #end-screen .btn-row { margin-bottom: 8px; }
        #end-screen .btn-row button { font-size: 9px; }
        #name-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,26,0.95); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Press Start 2P', monospace; color: #ffcc00;
        }
        #name-overlay.hidden { display: none; }
        #name-overlay h1 { font-size: 16px; margin-bottom: 20px; text-shadow: 0 0 10px #ff8800; }
        #name-overlay p { font-size: 8px; }
        #name-overlay input {
            font-size: 12px; padding: 10px 16px; width: 240px; text-align: center;
            background: #112; border: 2px solid #ffcc00; color: #fff; border-radius: 0;
            font-family: 'Press Start 2P', monospace; outline: none;
        }
        #name-overlay button { margin-top: 16px; font-size: 10px; padding: 10px 32px; font-family: 'Press Start 2P', monospace; cursor: pointer; }
        #name-overlay #lb-btn-start { margin-top: 10px; }
        #lb-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,26,0.92); z-index: 10001;
            display: none; flex-direction: column; align-items: center; justify-content: flex-start;
            font-family: 'Press Start 2P', monospace; color: #fff; padding-top: 40px; overflow-y: auto;
        }
        #lb-overlay.show { display: flex; }
        #lb-overlay h2 { color: #ffcc00; font-size: 14px; margin-bottom: 10px; }
        .lb-tabs { display: flex; gap: 10px; margin-bottom: 12px; }
        .lb-tabs button { font-size: 8px; padding: 6px 12px; background: #223; color: #aaa; border: 1px solid #555; cursor: pointer; font-family: 'Press Start 2P', monospace; }
        .lb-tabs button.active { background: #446; color: #ffcc00; border-color: #ffcc00; }
        .lb-table { width: 90%; max-width: 360px; }
        .lb-row { display: flex; justify-content: space-between; padding: 6px 8px; border-bottom: 1px solid #333; font-size: 8px; }
        .lb-row.header { color: #ffcc00; font-weight: bold; border-bottom: 2px solid #555; }
        .lb-row .rank { width: 24px; }
        .lb-row .name { flex: 1; }
        .lb-row .games { width: 36px; text-align: right; }
        .lb-row .avg { width: 50px; text-align: right; color: #ffcc00; }
        .lb-row .kills { width: 40px; text-align: right; }
        #lb-close { position: fixed; top: 12px; left: 12px; font-size: 10px; padding: 6px 14px; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid #555; cursor: pointer; font-family: 'Press Start 2P', monospace; z-index: 10002; }
        #mm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,26,0.92); z-index: 600;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Press Start 2P', monospace; color: #fff;
        }
        #mm-overlay.show { display: flex; }
        #mm-overlay .mm-title { color: #ffcc00; font-size: 14px; margin-bottom: 16px; text-shadow: 0 0 8px #ff8800; }
        #mm-overlay .mm-status { font-size: 10px; margin-bottom: 8px; color: #ccc; }
        #mm-overlay .mm-countdown { font-size: 24px; color: #ff8800; margin-bottom: 16px; }
        #mm-overlay .mm-players { font-size: 8px; color: #aaa; margin-bottom: 16px; max-height: 120px; overflow-y: auto; }
        #mm-skip-btn { font-size: 9px; padding: 8px 24px; cursor: pointer; font-family: 'Press Start 2P', monospace; }
    </style>
</head>
<body>

<div id="start-screen">
    <div class="nes-container is-dark panel">
        <p class="title">‚öì SHIP ROYALE ‚öì</p>
        <p class="subtitle">12 ships enter ¬∑ 1 survives</p>
        <p class="subtitle" style="margin-bottom:8px;">‚Äî POWER-UPS ‚Äî</p>
        <div class="legend">
            <div class="legend-row"><img src="assets/loot_torpedo.png?v=1740874000"><span>Torpedo pickup</span></div>
            <div class="legend-row"><img src="assets/loot_heal.png?v=1740874000"><span>Repair kit +3 HP</span></div>
            <div class="legend-row"><img src="assets/loot_speed.png?v=1740874000"><span>Speed boost 1.5x</span></div>
            <div class="legend-row"><img src="assets/loot_cannon.png?v=1740874000"><span>Fast cannon</span></div>
            <div class="legend-row"><img src="assets/loot_mine.png?v=1740874000"><span>Sea mine</span></div>
        </div>
        <p class="hint">Tap to set waypoints<br>Stay out of The Abyss!</p>
        <div class="btn-row"><button id="start-btn" class="nes-btn is-success" style="width:100%">‚öì START</button></div>
        <div class="btn-row"><button id="start-lb-btn" class="nes-btn is-warning" style="width:100%">üèÜ LEADERBOARD</button></div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:4px">
            <button id="start-name-btn">‚úèÔ∏è Set Name</button>
            <button id="start-music-btn" style="font-size:8px;color:#aaa;background:transparent;border:1px solid #555;cursor:pointer;padding:4px 8px;">üîä Music</button>
        </div>
    </div>
</div>

<div id="hud">
    <div id="hud-stats" class="nes-container is-dark">
        <div id="hud-hp">HP: 10/10</div>
        <div id="hud-alive">‚öì 9 alive</div>
        <div id="hud-xp">‚≠ê 0 XP</div>
        <div id="hud-zone"></div>
    </div>
    <div id="hud-actions">
        <div class="action-btn" id="btn-torpedo">
            <img src="assets/torpedo_btn.png?v=1740874000">
            <span class="count" id="torpedo-count">x1</span>
        </div>
        <div class="action-btn disabled" id="btn-mine">
            <img src="assets/mine_btn.png?v=1740874000">
            <span class="count" id="mine-count">x0</span>
        </div>
    </div>
    <div id="hud-buffs">
        <div class="buff-icon" id="buff-speed">
            <img src="assets/loot_speed.png?v=1740874000">
            <div class="timer" id="speed-timer"></div>
        </div>
        <div class="buff-icon" id="buff-cannon">
            <img src="assets/loot_cannon.png?v=1740874000">
            <div class="timer" id="cannon-timer"></div>
        </div>
    </div>
</div>

<div id="end-screen">
    <div class="nes-container is-dark panel">
        <p class="end-title" id="end-title"></p>
        <div class="end-stats" id="end-stats"></div>
        <div class="btn-row"><button id="end-restart-btn" class="nes-btn is-success" style="width:100%">PLAY AGAIN</button></div>
        <div class="btn-row"><button id="end-lb-btn" class="nes-btn is-warning" style="width:100%">üèÜ LEADERBOARD</button></div>
    </div>
</div>

<div id="name-overlay" class="hidden">
    <h1>‚öì SHIP ROYALE ‚öì</h1>
    <p style="color:#aaa;margin-bottom:12px;">Enter your captain name</p>
    <input id="name-input" class="nes-input" type="text" maxlength="20" placeholder="Captain...">
    <button id="name-btn" class="nes-btn is-success">SET SAIL</button>
    <button id="lb-btn-start" class="nes-btn is-warning">üèÜ LEADERBOARD</button>
</div>
<div id="lb-overlay">
    <h2>üèÜ LEADERBOARD</h2>
    <div class="lb-tabs">
        <button id="lb-tab-best" class="active">Best Game</button>
        <button id="lb-tab-today">Today</button>
        <button id="lb-tab-alltime">All Time</button>
    </div>
    <div id="lb-content" class="lb-table"></div>
    <button id="lb-close">‚Üê Back</button>
</div>
<div id="mm-overlay">
    <p class="mm-title">‚öì FINDING OPPONENTS ‚öì</p>
    <p class="mm-status" id="mm-status">Connecting...</p>
    <p class="mm-countdown" id="mm-countdown">30</p>
    <div class="mm-players" id="mm-players"></div>
    <button id="mm-skip-btn" class="nes-btn is-warning">START NOW</button>
</div>

<div id="splash">
    <img src="assets/splash.jpg" alt="Ship Royale">
    <div id="splash-tap">TAP TO START</div>
</div>
<script>
(function() {
    var splash = document.getElementById('splash');
    var tapText = document.getElementById('splash-tap');
    setInterval(function() { tapText.style.opacity = tapText.style.opacity === '0' ? '1' : '0'; }, 600);
    splash.addEventListener('click', function() {
        var ctx = window.AudioContext || window.webkitAudioContext;
        if (ctx) { var ac = new ctx(); var buf = ac.createBuffer(1, 1, 22050); var src = ac.createBufferSource(); src.buffer = buf; src.connect(ac.destination); src.start(0); }
        window.AUDIO_UNLOCKED = true;
        splash.classList.add('fade');
        setTimeout(function() { splash.remove(); }, 500);
    });
    splash.addEventListener('touchstart', function(e) { e.preventDefault(); splash.click(); }, { passive: false });
})();
</script>
<script>
// --- Username + Leaderboard UI (unchanged) ---
(function() {
    var overlay = document.getElementById('name-overlay');
    var input = document.getElementById('name-input');
    var btn = document.getElementById('name-btn');
    var lbBtnStart = document.getElementById('lb-btn-start');
    var lbOverlay = document.getElementById('lb-overlay');
    var lbContent = document.getElementById('lb-content');
    var lbClose = document.getElementById('lb-close');
    var lbTabBest = document.getElementById('lb-tab-best');
    var lbTabToday = document.getElementById('lb-tab-today');
    var lbTabAll = document.getElementById('lb-tab-alltime');

    var playerId = localStorage.getItem('warship_pid');
    if (!playerId) {
        playerId = 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
        localStorage.setItem('warship_pid', playerId);
    }
    window.WARSHIP_PID = playerId;

    var saved = localStorage.getItem('warship_name');
    if (saved) {
        window.WARSHIP_PLAYER = saved;
    } else {
        overlay.classList.remove('hidden');
        var sp = document.getElementById('splash');
        if (sp) sp.remove();
    }

    window.showNameChange = function() {
        input.value = window.WARSHIP_PLAYER || '';
        overlay.classList.remove('hidden');
    };

    function setName() {
        var name = input.value.trim().slice(0, 20);
        if (!name) return;
        var oldName = window.WARSHIP_PLAYER;
        localStorage.setItem('warship_name', name);
        window.WARSHIP_PLAYER = name;
        overlay.classList.add('hidden');
        var snb = document.getElementById('start-name-btn');
        if (snb) snb.textContent = '‚úèÔ∏è ' + name;
        if (oldName && oldName !== name) {
            fetch('/warship/api/rename', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playerId: window.WARSHIP_PID, oldName: oldName, newName: name })
            }).catch(function(){});
        }
    }
    btn.addEventListener('click', setName);
    input.addEventListener('keydown', function(e) { if (e.key === 'Enter') setName(); });

    function setActiveTab(active) {
        [lbTabBest, lbTabToday, lbTabAll].forEach(function(t) { t.classList.remove('active'); });
        active.classList.add('active');
    }
    function showLeaderboard(tab) {
        var url = tab === 'best' ? '/warship/api/leaderboard/best' : (tab === 'today' ? '/warship/api/leaderboard/today' : '/warship/api/leaderboard');
        lbContent.innerHTML = '<p style="color:#888;padding:20px;">Loading...</p>';
        lbOverlay.classList.add('show');
        fetch(url).then(function(r) { return r.json(); }).then(function(rows) {
            var html;
            if (tab === 'best') {
                html = '<div class="lb-row header"><span class="rank">#</span><span class="name">Captain</span><span class="kills">K</span><span class="avg">XP</span></div>';
                if (!rows.length) html += '<div class="lb-row"><span style="color:#888;">No scores yet</span></div>';
                for (var i = 0; i < rows.length; i++) {
                    var r = rows[i]; var crown = r.won ? ' üëë' : '';
                    html += '<div class="lb-row"><span class="rank">' + (i+1) + '</span><span class="name">' + r.username + crown + '</span><span class="kills">' + (r.kills||0) + '</span><span class="avg">' + (r.xp||0) + '</span></div>';
                }
            } else {
                html = '<div class="lb-row header"><span class="rank">#</span><span class="name">Captain</span><span class="games">GP</span><span class="kills">K</span><span class="avg">XP</span></div>';
                if (!rows.length) html += '<div class="lb-row"><span style="color:#888;">No scores yet</span></div>';
                for (var i = 0; i < rows.length; i++) {
                    var r = rows[i];
                    html += '<div class="lb-row"><span class="rank">' + (i+1) + '</span><span class="name">' + r.username + '</span><span class="games">' + (r.games||0) + '</span><span class="kills">' + (r.total_kills||0) + '</span><span class="avg">' + (r.total_xp||0) + '</span></div>';
                }
            }
            lbContent.innerHTML = html;
        }).catch(function() { lbContent.innerHTML = '<p style="color:#f66;">Failed to load</p>'; });
    }

    lbBtnStart.addEventListener('click', function() { showLeaderboard('best'); });
    lbTabBest.addEventListener('click', function() { setActiveTab(lbTabBest); showLeaderboard('best'); });
    lbTabToday.addEventListener('click', function() { setActiveTab(lbTabToday); showLeaderboard('today'); });
    lbTabAll.addEventListener('click', function() { setActiveTab(lbTabAll); showLeaderboard('alltime'); });
    lbClose.addEventListener('click', function() { lbOverlay.classList.remove('show'); });
    window.showWarshipLeaderboard = function() { setActiveTab(lbTabBest); showLeaderboard('best'); };
})();
</script>
<script>
(function() {
    // === Constants (rendering only) ===
    var MAP_W = 4000, MAP_H = 3200;
    var MAP_PAD = 50;
    var MAX_HP = 10;
    var LOOT_TYPES = { T: 0xff4444, H: 0x44ff44, S: 0x4488ff, C: 0xffaa00, M: 0x444444 };

    // === State ===
    var scene, ws;
    var mySlot = -1;
    var gameStarted = false, gameOver = false;
    var bgMusic;
    var musicMuted = localStorage.getItem('warship_music_muted') === '1';

    // Sprite maps
    var shipSprites = {};   // slot -> { sprite, hpBarBg, hpBar, nameText }
    var cannonballGfx;      // graphics object for cannonballs
    var torpedoSprites = []; // array of sprites
    var mineSprites = {};   // key -> sprite
    var lootSprites = {};   // id -> sprite
    var monsterSprites = []; // array of { s1, s2 }
    var blastGfx;
    var zoneGraphics, minimapGraphics, routeGraphics, combatGraphics;
    var waypointMarkers = [];
    var localWaypoints = []; // local waypoint tracking for route display

    // Island defs (sent by server on gameStart)
    var islandDefs = [];
    var islandCircles = [];
    var islandSizes = { island1: 85, island2: 80, island3: 90, island4: 75, island5: 85, island6: 80, island7: 90 };

    // Last server state
    var serverState = null;
    var playerXP = 0;
    var playerKills = 0;

    // DOM refs
    var domHp = document.getElementById('hud-hp');
    var domAlive = document.getElementById('hud-alive');
    var domXp = document.getElementById('hud-xp');
    var domZone = document.getElementById('hud-zone');
    var domTorpedoCount = document.getElementById('torpedo-count');
    var domMineCount = document.getElementById('mine-count');
    var domBtnTorpedo = document.getElementById('btn-torpedo');
    var domBtnMine = document.getElementById('btn-mine');
    var domBuffSpeed = document.getElementById('buff-speed');
    var domBuffCannon = document.getElementById('buff-cannon');
    var domSpeedTimer = document.getElementById('speed-timer');
    var domCannonTimer = document.getElementById('cannon-timer');
    var domStartScreen = document.getElementById('start-screen');
    var domHud = document.getElementById('hud');
    var domEndScreen = document.getElementById('end-screen');
    var domEndTitle = document.getElementById('end-title');
    var domEndStats = document.getElementById('end-stats');
    var domMmOverlay = document.getElementById('mm-overlay');
    var domMmStatus = document.getElementById('mm-status');
    var domMmCountdown = document.getElementById('mm-countdown');
    var domMmPlayers = document.getElementById('mm-players');

    var cheerQueue = [];
    function shuffleCheers() {
        var arr = ['sfx_cheer1','sfx_cheer2','sfx_cheer3','sfx_cheer4'];
        for (var i = arr.length - 1; i > 0; i--) { var j = Math.floor(Math.random() * (i + 1)); var t = arr[i]; arr[i] = arr[j]; arr[j] = t; }
        if (cheerQueue.length > 0 && arr[0] === cheerQueue[cheerQueue.length - 1]) { var tmp = arr[0]; arr[0] = arr[1]; arr[1] = tmp; }
        return arr;
    }

    function playClick() { try { scene.sound.play('sfx_click', { volume: 0.5 }); } catch(e) {} }

    // === Matchmaking ===
    function startMatchmaking() {
        domMmOverlay.classList.add('show');
        domMmStatus.textContent = 'Connecting...';
        domMmCountdown.textContent = '';
        document.getElementById('mm-skip-btn').textContent = 'START NOW';
        document.getElementById('mm-skip-btn').disabled = false;
        domMmPlayers.innerHTML = '';

        var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(proto + '//' + location.host + '/warship/api/ws');

        ws.onopen = function() {
            ws.send(JSON.stringify({ type: 'join', name: window.WARSHIP_PLAYER || 'Anonymous', playerId: window.WARSHIP_PID }));
        };

        ws.onmessage = function(evt) {
            var msg;
            try { msg = JSON.parse(evt.data); } catch { return; }

            if (msg.type === 'waiting') {
                var readyTxt = msg.ready ? ' (' + msg.ready + '/' + msg.players + ' ready)' : '';
                domMmStatus.textContent = msg.players + '/12 players' + readyTxt;
                domMmCountdown.textContent = msg.countdown;
                if (msg.names) domMmPlayers.innerHTML = msg.names.map(function(n) { return '<div>‚öì ' + n + '</div>'; }).join('');
            } else if (msg.type === 'gameStart') {
                domMmOverlay.classList.remove('show');
                mySlot = msg.slot;
                islandDefs = msg.islands || [];
                gameStarted = true;
                gameOver = false;
                playerXP = 0;
                playerKills = 0;

                // Restart scene to set up rendering
                window._gsData = msg;
                scene.scene.restart();
            } else if (msg.type === 'state') {
                serverState = msg;
            } else if (msg.type === 'kill') {
                handleKillEvent(msg);
            } else if (msg.type === 'sound') {
                handleSoundEvent(msg);
            } else if (msg.type === 'gameOver') {
                handleGameOver(msg);
            } else if (msg.type === 'info') {
                // Could show disconnect info etc
            }
        };

        ws.onerror = function() {
            domMmOverlay.classList.remove('show');
            domStartScreen.classList.remove('hidden');
        };

        ws.onclose = function() { ws = null; };
    }

    function handleKillEvent(msg) {
        if (!scene || !gameStarted) return;
        if (msg.killer === 'You') {
            playerKills++;
            playerXP += 100;
            if (cheerQueue.length === 0) cheerQueue = shuffleCheers();
            try { scene.sound.play(cheerQueue.shift(), { volume: 0.8 }); } catch(e) {}
        }
        addElimMessage(msg.victim, msg.victimColor, msg.killer, msg.killerColor);
    }

    function handleSoundEvent(msg) {
        if (!scene) return;
        try { scene.sound.play(msg.name, { volume: msg.volume || 0.5 }); } catch(e) {}
    }

    function handleGameOver(msg) {
        gameOver = true;
        if (bgMusic) bgMusic.setVolume(0.3);
        try { scene.sound.play(msg.won ? 'sfx_victory' : 'sfx_defeat', { volume: 0.9 }); } catch(e) {}

        playerXP = msg.xp || 0;
        var title = msg.won ? 'üè¥‚Äç‚ò†Ô∏è VICTORY ROYALE üè¥‚Äç‚ò†Ô∏è' : 'üíÄ DEFEATED';
        if (!msg.won) title += '\n' + getPlaceStr(msg.place);
        domEndTitle.textContent = title;

        var mins = Math.floor((msg.time || 0) / 60), secs = Math.floor((msg.time || 0) % 60);
        var prevBest = parseInt(localStorage.getItem('warship_best_xp') || '0', 10);
        var isNewRecord = playerXP > prevBest;
        if (isNewRecord) localStorage.setItem('warship_best_xp', '' + playerXP);
        var recordLabel = isNewRecord ? '<span style="color:#ff5555">üèÜ NEW RECORD!</span>' : '<span style="color:#aaa">Record: ' + prevBest + ' XP</span>';
        domEndStats.innerHTML =
            'Kills: ' + (msg.kills || 0) +
            '<br>Hits: ' + (msg.hits || 0) +
            '<br>Torpedoes: ' + (msg.torpsFired || 0) +
            '<br>Time: ' + mins + 'm ' + secs + 's' +
            '<br><br><span style="color:#ffcc00">‚≠ê ' + playerXP + ' XP</span>' +
            '<br>' + recordLabel;
        domHud.classList.remove('show');
        domEndScreen.classList.add('show');
    }

    function getPlaceStr(n) {
        if (n === 1) return '1st place'; if (n === 2) return '2nd place'; if (n === 3) return '3rd place';
        return n + 'th place';
    }

    function addElimMessage(victimName, victimColor, killerName, killerColor) {
        if (!scene) return;
        var camW = scene.cameras.main.width;
        var msg = killerName + ' sank ' + victimName + '!';
        var yOff = 0;
        var txt = scene.add.text(camW / 2, 100 + yOff, msg, {
            fontSize: '18px', fontFamily: 'monospace', fontStyle: 'bold',
            color: killerColor, stroke: '#000000', strokeThickness: 4
        }).setScrollFactor(0).setDepth(200).setOrigin(0.5, 0.5).setAlpha(1);
        scene.tweens.add({
            targets: txt, alpha: 0, y: txt.y - 20,
            duration: 3000, delay: 1000, ease: 'Power2',
            onComplete: function() { txt.destroy(); }
        });
    }

    // === Wire up buttons ===
    var startNameBtn = document.getElementById('start-name-btn');
    if (window.WARSHIP_PLAYER) startNameBtn.textContent = '‚úèÔ∏è ' + window.WARSHIP_PLAYER;
    startNameBtn.addEventListener('click', function(e) { e.stopPropagation(); playClick(); if (window.showNameChange) window.showNameChange(); });

    var musicBtn = document.getElementById('start-music-btn');
    function updateMusicBtn() { musicBtn.textContent = musicMuted ? 'üîá Music' : 'üîä Music'; }
    updateMusicBtn();
    musicBtn.addEventListener('click', function(e) {
        e.stopPropagation(); playClick();
        musicMuted = !musicMuted;
        localStorage.setItem('warship_music_muted', musicMuted ? '1' : '0');
        updateMusicBtn();
        if (bgMusic) bgMusic.setMute(musicMuted);
    });

    document.getElementById('start-lb-btn').addEventListener('click', function(e) { e.stopPropagation(); playClick(); if (window.showWarshipLeaderboard) window.showWarshipLeaderboard(); });

    document.getElementById('start-btn').addEventListener('click', function(e) {
        e.stopPropagation(); playClick();
        domStartScreen.classList.add('hidden');
        startMatchmaking();
    });

    document.getElementById('hud-actions').addEventListener('touchstart', function(e) { e.stopPropagation(); }, { passive: false });
    document.getElementById('hud-actions').addEventListener('pointerdown', function(e) { e.stopPropagation(); });
    document.getElementById('hud-stats').addEventListener('touchstart', function(e) { e.stopPropagation(); }, { passive: false });
    document.getElementById('hud-stats').addEventListener('pointerdown', function(e) { e.stopPropagation(); });

    domBtnTorpedo.addEventListener('click', function(e) {
        e.stopPropagation();
        if (gameOver || !gameStarted || !ws || ws.readyState !== 1) return;
        playClick();
        ws.send(JSON.stringify({ type: 'fireTorpedo' }));
    });

    domBtnMine.addEventListener('click', function(e) {
        e.stopPropagation();
        if (gameOver || !gameStarted || !ws || ws.readyState !== 1) return;
        playClick();
        ws.send(JSON.stringify({ type: 'layMine' }));
    });

    document.getElementById('end-restart-btn').addEventListener('click', function() {
        playClick();
        if (bgMusic) bgMusic.setVolume(0.35);
        gameOver = false;
        gameStarted = false;
        serverState = null;
        mySlot = -1;
        domEndScreen.classList.remove('show');
        domHud.classList.remove('show');
        domStartScreen.classList.remove('hidden');
        if (ws) { ws.close(); ws = null; }
    });

    document.getElementById('end-lb-btn').addEventListener('click', function() { playClick(); if (window.showWarshipLeaderboard) window.showWarshipLeaderboard(); });

    document.getElementById('mm-skip-btn').addEventListener('click', function(e) {
        e.stopPropagation(); playClick();
        if (ws && ws.readyState === 1) {
            ws.send(JSON.stringify({ type: 'skip' }));
            document.getElementById('mm-skip-btn').textContent = '‚úì READY';
            document.getElementById('mm-skip-btn').disabled = true;
        }
    });

    // === Phaser Game ===
    var config = {
        type: Phaser.AUTO,
        scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH, width: '100%', height: '100%' },
        physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
        scene: { preload: preload, create: create, update: update },
        input: { activePointers: 2 },
    };
    var game = new Phaser.Game(config);

    function preload() {
        this.load.image('ship', 'assets/ship2.png?v=1740874000');
        this.load.image('water', 'assets/water.png?v=1740874000');
        this.load.image('torpedo', 'assets/torpedo.png');
        this.load.image('kraken1', 'assets/kraken1.png?v=2');
        this.load.image('kraken2', 'assets/kraken2.png?v=2');
        this.load.image('serpent1', 'assets/serpent1.png?v=2');
        this.load.image('serpent2', 'assets/serpent2.png?v=2');
        this.load.image('torpedo_btn', 'assets/torpedo_btn.png?v=1740874000');
        this.load.image('mine', 'assets/mine.png?v=1740874000');
        this.load.image('mine_btn', 'assets/mine_btn.png?v=1740874000');
        this.load.image('loot_M', 'assets/loot_mine.png?v=1740874000');
        this.load.image('loot_T', 'assets/loot_torpedo.png?v=1740874000');
        this.load.image('loot_H', 'assets/loot_heal.png?v=1740874000');
        this.load.image('loot_S', 'assets/loot_speed.png?v=1740874000');
        this.load.image('loot_C', 'assets/loot_cannon.png?v=1740874000');
        this.load.audio('sfx_sink', 'assets/sfx_sink.mp3');
        this.load.audio('sfx_victory', 'assets/sfx_victory.mp3');
        this.load.audio('sfx_defeat', 'assets/sfx_defeat.mp3');
        this.load.audio('sfx_cheer1', 'assets/sfx_cheer1.mp3');
        this.load.audio('sfx_cheer2', 'assets/sfx_cheer2.mp3');
        this.load.audio('sfx_cheer3', 'assets/sfx_cheer3.mp3');
        this.load.audio('sfx_cheer4', 'assets/sfx_cheer4.mp3');
        this.load.audio('sfx_pickup', 'assets/sfx_pickup.mp3');
        this.load.audio('sfx_music', 'assets/sfx_music.mp3');
        this.load.audio('sfx_heal', 'assets/sfx_heal.mp3');
        this.load.audio('sfx_speed', 'assets/sfx_speed.mp3');
        this.load.audio('sfx_cannon', 'assets/sfx_cannon.mp3');
        this.load.audio('sfx_mine', 'assets/sfx_mine.mp3');
        this.load.audio('sfx_torpedo', 'assets/sfx_torpedo.mp3');
        this.load.audio('sfx_start1', 'assets/sfx_start1.mp3');
        this.load.audio('sfx_start2', 'assets/sfx_start2.mp3');
        this.load.audio('sfx_start3', 'assets/sfx_start3.mp3');
        this.load.audio('sfx_start4', 'assets/sfx_start4.mp3');
        this.load.audio('sfx_click', 'assets/sfx_click.mp3');
        this.load.audio('sfx_kraken', 'assets/sfx_kraken.mp3');
        for (var i = 1; i <= 7; i++) this.load.image('island' + i, 'assets/island' + i + '.png?v=1740874000');
    }

    function create() {
        scene = this;

        // Clean up old sprites
        shipSprites = {};
        torpedoSprites = [];
        mineSprites = {};
        lootSprites = {};
        monsterSprites = [];
        waypointMarkers = [];
        localWaypoints = [];

        // Water tiles
        var wImg = this.textures.get('water').getSourceImage();
        var tw = wImg.width, th = wImg.height;
        for (var x = 0; x < MAP_W; x += tw)
            for (var y = 0; y < MAP_H; y += th)
                this.add.image(x + tw/2, y + th/2, 'water');

        zoneGraphics = this.add.graphics().setDepth(3);
        routeGraphics = this.add.graphics().setDepth(4);
        combatGraphics = this.add.graphics().setDepth(15);
        minimapGraphics = this.add.graphics().setScrollFactor(0).setDepth(150);

        // Islands
        var gsData = window._gsData;
        if (gsData && gsData.islands) {
            islandDefs = gsData.islands;
        }
        islandCircles = [];
        for (var i = 0; i < islandDefs.length; i++) {
            var def = islandDefs[i];
            this.add.image(def.x, def.y, def.key).setScale(def.scale);
            islandCircles.push({ x: def.x, y: def.y, r: (islandSizes[def.key] || 80) * def.scale * 0.45 });
        }

        // Monsters (initial from gameStart)
        if (gsData && gsData.monsters) {
            for (var mi = 0; mi < gsData.monsters.length; mi++) {
                var m = gsData.monsters[mi];
                var ms1 = this.add.image(m.x, m.y, m.type + '1').setDepth(2).setScale(0.7).setAlpha(0.85);
                var ms2 = this.add.image(m.x, m.y, m.type + '2').setDepth(2).setScale(0.7).setAlpha(0).setVisible(false);
                monsterSprites.push({ s1: ms1, s2: ms2, lastFrame: 0 });
            }
        }

        // Camera
        this.cameras.main.setBounds(0, 0, MAP_W, MAP_H);

        // Click to set waypoint
        this.input.on('pointerdown', function(pointer) {
            if (gameOver || !gameStarted || !ws || ws.readyState !== 1) return;
            var mmW2 = 140, mmH2 = Math.round(mmW2 * MAP_H / MAP_W);
            if (pointer.x > scene.cameras.main.width - mmW2 - 15 && pointer.y < mmH2 + 15) return;
            var wp = scene.cameras.main.getWorldPoint(pointer.x, pointer.y);
            wp.x = Phaser.Math.Clamp(wp.x, MAP_PAD + 20, MAP_W - MAP_PAD - 20);
            wp.y = Phaser.Math.Clamp(wp.y, MAP_PAD + 20, MAP_H - MAP_PAD - 20);
            // Don't click inside islands
            for (var ic = 0; ic < islandCircles.length; ic++) {
                var isl = islandCircles[ic];
                if ((wp.x-isl.x)*(wp.x-isl.x)+(wp.y-isl.y)*(wp.y-isl.y) < isl.r*isl.r) return;
            }
            ws.send(JSON.stringify({ type: 'waypoint', x: Math.round(wp.x), y: Math.round(wp.y) }));
            // Local waypoint marker for immediate feedback
            localWaypoints.push({ x: wp.x, y: wp.y });
            var dot = scene.add.circle(wp.x, wp.y, 5, 0xffff00, 0.85).setDepth(5);
            waypointMarkers.push(dot);
        });

        // Keyboard hotkeys
        this.input.keyboard.on('keydown-A', function() { domBtnTorpedo.click(); });
        this.input.keyboard.on('keydown-S', function() { domBtnMine.click(); });

        // Music
        if (scene.sound.context && scene.sound.context.state === 'suspended') scene.sound.context.resume();
        if (!bgMusic) {
            bgMusic = scene.sound.add('sfx_music', { loop: true, volume: 0.35 });
            bgMusic.setMute(musicMuted);
            bgMusic.play();
        }

        // If game already started (scene restart after gameStart)
        if (gameStarted && gsData) {
            window._gsData = null;
            domStartScreen.classList.add('hidden');
            domHud.classList.add('show');
            if (bgMusic) bgMusic.setVolume(0.22);
            var startVoices = ['sfx_start1','sfx_start2','sfx_start3','sfx_start4'];
            try { scene.sound.play(startVoices[Math.floor(Math.random()*startVoices.length)], { volume: 0.9 }); } catch(e) {}
        }
    }

    // Keep track of which ships have been sunk (to play animation once)
    var sunkSlots = {};

    function sinkShip(sprite) {
        scene.tweens.add({
            targets: sprite,
            scaleX: 0.3, scaleY: 0.3, angle: sprite.angle + 120, alpha: 0,
            duration: 1500, ease: 'Power2',
            onComplete: function() { sprite.setVisible(false); }
        });
        for (var bi = 0; bi < 6; bi++) {
            var bx = sprite.x + (Math.random() - 0.5) * 40;
            var by = sprite.y + (Math.random() - 0.5) * 40;
            var bubble = scene.add.circle(bx, by, 3 + Math.random() * 4, 0xffffff, 0.6).setDepth(12);
            scene.tweens.add({
                targets: bubble, y: by - 30 - Math.random() * 20, alpha: 0,
                duration: 800 + Math.random() * 600, delay: bi * 100,
                ease: 'Power1', onComplete: function() { bubble.destroy(); }
            });
        }
    }

    function update(time, delta) {
        if (!scene || !gameStarted || !serverState) return;
        if (gameOver) return;

        var st = serverState;
        var dt = Math.min(delta / 1000, 0.05);
        var camW = scene.cameras.main.width, camH = scene.cameras.main.height;

        // === Update ships ===
        for (var si = 0; si < st.ships.length; si++) {
            var sd = st.ships[si];
            var sp = shipSprites[sd.slot];

            if (!sp) {
                // Create ship sprite
                var spr = scene.add.image(sd.x, sd.y, 'ship').setDepth(10);
                if (sd.slot !== mySlot) spr.setTint(sd.color);
                var hpBg = scene.add.rectangle(0, 0, 50, 6, 0x333333).setDepth(20).setOrigin(0.5, 0.5);
                var hpBar = scene.add.rectangle(0, 0, 50, 6, sd.slot === mySlot ? 0x00ff00 : sd.color).setDepth(21).setOrigin(0, 0.5);
                sp = { sprite: spr, hpBarBg: hpBg, hpBar: hpBar, _ix: sd.x, _iy: sd.y, _ir: sd.rotation };
                shipSprites[sd.slot] = sp;
            }

            if (sd.alive) {
                // Smooth interpolation toward server position at 60fps
                var lerpSpeed = dt * 15; // fast catchup
                if (sp._ix === undefined) { sp._ix = sd.x; sp._iy = sd.y; sp._ir = sd.rotation; }
                sp._ix += (sd.x - sp._ix) * lerpSpeed;
                sp._iy += (sd.y - sp._iy) * lerpSpeed;
                var angleDiff = sd.rotation - sp._ir;
                // Wrap angle difference
                while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                sp._ir += angleDiff * lerpSpeed;
                sp.sprite.setPosition(sp._ix, sp._iy).setRotation(sp._ir).setVisible(true);
                sp.sprite.setScale(1); sp.sprite.setAlpha(1);
                sp.hpBarBg.setPosition(sp._ix, sp._iy - 35).setVisible(true);
                sp.hpBar.setPosition(sp._ix - 25, sp._iy - 35).setVisible(true);
                sp.hpBar.width = 50 * (sd.hp / MAX_HP);

                // Flash on damage
                if (sp._lastHp !== undefined && sd.hp < sp._lastHp) {
                    if (sd.slot === mySlot) sp.sprite.setTint(0xff0000);
                    else sp.sprite.setTint(0xffffff);
                    var ref = sp; var col = sd.color; var isMe = sd.slot === mySlot;
                    scene.time.delayedCall(100, function() {
                        if (isMe) ref.sprite.clearTint();
                        else ref.sprite.setTint(col);
                    });
                }
                sp._lastHp = sd.hp;
            } else {
                if (!sunkSlots[sd.slot]) {
                    sunkSlots[sd.slot] = true;
                    sinkShip(sp.sprite);
                }
                sp.hpBarBg.setVisible(false);
                sp.hpBar.setVisible(false);
            }

            // Follow own ship
            if (sd.slot === mySlot && sd.alive) {
                scene.cameras.main.startFollow(sp.sprite, true, 0.08, 0.08);
            }
        }

        // === Update own ship HUD ===
        var myShip = null;
        for (var ms = 0; ms < st.ships.length; ms++) {
            if (st.ships[ms].slot === mySlot) { myShip = st.ships[ms]; break; }
        }
        if (myShip) {
            domHp.textContent = 'HP: ' + Math.ceil(myShip.hp) + '/' + MAX_HP;
            if (myShip.hp <= 3) domHp.style.color = '#ff4444';
            else if (myShip.hp <= 6) domHp.style.color = '#ffff00';
            else domHp.style.color = '#00ff00';

            domTorpedoCount.textContent = 'x' + myShip.torpedoes;
            domMineCount.textContent = 'x' + myShip.mines;
            if (myShip.torpedoes > 0) domBtnTorpedo.classList.remove('disabled'); else domBtnTorpedo.classList.add('disabled');
            if (myShip.mines > 0) domBtnMine.classList.remove('disabled'); else domBtnMine.classList.add('disabled');

            if (myShip.speedBuff > 0) { domBuffSpeed.classList.add('active'); domSpeedTimer.textContent = myShip.speedBuff + 's'; }
            else domBuffSpeed.classList.remove('active');
            if (myShip.fireBuff > 0) { domBuffCannon.classList.add('active'); domCannonTimer.textContent = myShip.fireBuff + 's'; }
            else domBuffCannon.classList.remove('active');

            // Clear local waypoints that the ship has passed or is near
            while (localWaypoints.length > 0 && waypointMarkers.length > 0) {
                var d = Phaser.Math.Distance.Between(myShip.x, myShip.y, localWaypoints[0].x, localWaypoints[0].y);
                if (d < 60) {
                    localWaypoints.shift();
                    waypointMarkers[0].destroy();
                    waypointMarkers.shift();
                } else break;
            }
            // Clear all waypoints if dead or server has no waypoints left for us
            if (!myShip.alive || (myShip.waypoints !== undefined && myShip.waypoints === 0)) {
                for (var cwi = 0; cwi < waypointMarkers.length; cwi++) waypointMarkers[cwi].destroy();
                waypointMarkers = [];
                localWaypoints = [];
            }
        }

        domAlive.textContent = '‚öì ' + (st.alive - 1) + ' enemies';
        domXp.textContent = '‚≠ê ' + playerXP + ' XP';

        // === Draw cannonballs ===
        combatGraphics.clear();
        for (var ci = 0; ci < st.cannonballs.length; ci++) {
            var b = st.cannonballs[ci];
            var bcolor = b.owner === mySlot ? 0xffcc00 : 0xff6666;
            // Find owner color
            for (var bsi = 0; bsi < st.ships.length; bsi++) {
                if (st.ships[bsi].slot === b.owner) { bcolor = st.ships[bsi].slot === mySlot ? 0xffcc00 : st.ships[bsi].color; break; }
            }
            combatGraphics.fillStyle(bcolor, 1);
            combatGraphics.fillCircle(b.x, b.y, 4);
        }

        // === Draw torpedoes ===
        // Remove excess sprites
        while (torpedoSprites.length > st.torpedoes.length) { torpedoSprites.pop().destroy(); }
        for (var ti = 0; ti < st.torpedoes.length; ti++) {
            var td = st.torpedoes[ti];
            if (ti >= torpedoSprites.length) {
                torpedoSprites.push(scene.add.image(td.x, td.y, 'torpedo').setDepth(5));
            }
            torpedoSprites[ti].setPosition(td.x, td.y).setRotation(td.rotation).setVisible(true);
        }

        // === Draw mines ===
        var currentMineKeys = {};
        for (var mi = 0; mi < st.mines.length; mi++) {
            var md = st.mines[mi];
            var mk = md.x + ',' + md.y;
            currentMineKeys[mk] = true;
            if (!mineSprites[mk]) {
                var ms2 = scene.add.image(md.x, md.y, 'mine').setDepth(5).setScale(1.2);
                scene.tweens.add({ targets: ms2, y: md.y - 3, duration: 1500, yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });
                mineSprites[mk] = ms2;
            }
            mineSprites[mk].setAlpha(md.armed ? (md.life < 5 ? (0.5 + Math.sin(time / 100) * 0.5) : 1) : (Math.sin(time / 80) > 0 ? 0.8 : 0.2));
        }
        // Remove mines no longer in state
        for (var mk2 in mineSprites) {
            if (!currentMineKeys[mk2]) { mineSprites[mk2].destroy(); delete mineSprites[mk2]; }
        }

        // === Draw loot ===
        var currentLootIds = {};
        for (var li = 0; li < st.loot.length; li++) {
            var ld = st.loot[li];
            currentLootIds[ld.id] = true;
            if (!lootSprites[ld.id]) {
                var ls = scene.add.image(ld.x, ld.y, 'loot_' + ld.type).setDepth(6).setScale(1.2);
                scene.tweens.add({ targets: ls, y: ld.y - 4, duration: 1000 + Math.random() * 300, yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });
                lootSprites[ld.id] = ls;
            }
        }
        for (var lid in lootSprites) {
            if (!currentLootIds[lid]) { lootSprites[lid].destroy(); delete lootSprites[lid]; }
        }

        // === Draw zone ===
        zoneGraphics.clear();
        var z = st.zone;
        var pulse = 0.6 + Math.sin(time / 300) * 0.3;
        zoneGraphics.lineStyle(4, 0xcc44ff, pulse);
        zoneGraphics.strokeCircle(z.cx, z.cy, z.radius);
        zoneGraphics.lineStyle(2, 0xff00ff, pulse * 0.5);
        zoneGraphics.strokeCircle(z.cx, z.cy, z.radius + 8);

        if (z.phase < 5) {
            if (z.shrinking) {
                domZone.textContent = '‚ò† THE ABYSS IS CLOSING ‚ò†';
                domZone.style.color = '#ff44ff';
            } else if (z.timer > 0) {
                domZone.textContent = 'The Abyss closes in ' + z.timer + 's';
                domZone.style.color = '#ff88ff';
            } else {
                domZone.textContent = 'The Abyss - Final';
                domZone.style.color = '#ff44ff';
            }
        } else {
            domZone.textContent = 'The Abyss - Final';
            domZone.style.color = '#ff44ff';
        }

        // === Draw sea monsters ===
        for (var smi = 0; smi < st.monsters.length && smi < monsterSprites.length; smi++) {
            var sm = st.monsters[smi];
            var msp = monsterSprites[smi];
            msp.s1.setPosition(sm.x, sm.y);
            msp.s2.setPosition(sm.x, sm.y);
            if (sm.frame !== msp.lastFrame) {
                msp.s1.setVisible(sm.frame === 0).setAlpha(sm.frame === 0 ? 0.85 : 0);
                msp.s2.setVisible(sm.frame === 1).setAlpha(sm.frame === 1 ? 0.85 : 0);
                msp.lastFrame = sm.frame;
            }
        }

        // === Draw blasts ===
        for (var bi2 = 0; bi2 < st.blasts.length; bi2++) {
            var bl = st.blasts[bi2];
            combatGraphics.lineStyle(3, 0xff6600, 0.7);
            combatGraphics.strokeCircle(bl.x, bl.y, bl.radius);
            combatGraphics.fillStyle(0xff4400, 0.2);
            combatGraphics.fillCircle(bl.x, bl.y, bl.radius * 0.7);
        }

        // === Draw route ===
        routeGraphics.clear();
        if (myShip && localWaypoints.length > 0) {
            routeGraphics.lineStyle(2, 0xffff00, 0.5);
            routeGraphics.beginPath();
            routeGraphics.moveTo(myShip.x, myShip.y);
            for (var wi = 0; wi < localWaypoints.length; wi++) routeGraphics.lineTo(localWaypoints[wi].x, localWaypoints[wi].y);
            routeGraphics.strokePath();
        }

        // === Minimap ===
        minimapGraphics.clear();
        var cam = scene.cameras.main;
        var camL = cam.scrollX, camT = cam.scrollY;
        var mmW = 140, mmH = Math.round(mmW * MAP_H / MAP_W);
        var mmX = camW - mmW - 10, mmY = 10;
        var mmSX = mmW / MAP_W, mmSY = mmH / MAP_H;
        minimapGraphics.fillStyle(0x001122, 0.75);
        minimapGraphics.fillRect(mmX - 1, mmY - 1, mmW + 2, mmH + 2);
        minimapGraphics.lineStyle(1, 0x446688, 0.8);
        minimapGraphics.strokeRect(mmX - 1, mmY - 1, mmW + 2, mmH + 2);
        minimapGraphics.lineStyle(2, 0xcc44ff, 0.7);
        minimapGraphics.strokeCircle(mmX + z.cx * mmSX, mmY + z.cy * mmSY, z.radius * mmSX);

        for (var imi = 0; imi < islandCircles.length; imi++) {
            var mi3 = islandCircles[imi];
            minimapGraphics.fillStyle(0x44aa44, 0.7);
            minimapGraphics.fillCircle(mmX + mi3.x * mmSX, mmY + mi3.y * mmSY, Math.max(2, mi3.r * mmSX));
        }
        for (var mli = 0; mli < st.loot.length; mli++) {
            var ml = st.loot[mli];
            minimapGraphics.fillStyle(LOOT_TYPES[ml.type] || 0xffffff, 0.6);
            minimapGraphics.fillRect(mmX + ml.x * mmSX - 1, mmY + ml.y * mmSY - 1, 2, 2);
        }
        for (var mei = 0; mei < st.ships.length; mei++) {
            var sh = st.ships[mei];
            if (!sh.alive) continue;
            if (sh.slot === mySlot) {
                minimapGraphics.fillStyle(0xffffff, 1);
                minimapGraphics.fillCircle(mmX + sh.x * mmSX, mmY + sh.y * mmSY, 3.5);
                minimapGraphics.lineStyle(1, 0x000000, 0.6);
                minimapGraphics.strokeCircle(mmX + sh.x * mmSX, mmY + sh.y * mmSY, 3.5);
            } else {
                minimapGraphics.fillStyle(sh.color, 1);
                minimapGraphics.fillCircle(mmX + sh.x * mmSX, mmY + sh.y * mmSY, 3);
            }
        }
        minimapGraphics.lineStyle(1, 0xffffff, 0.3);
        minimapGraphics.strokeRect(mmX + camL * mmSX, mmY + camT * mmSY, camW * mmSX, camH * mmSY);

        // === Off-screen indicators ===
        var camR = camL + camW, camB = camT + camH;
        for (var oi = 0; oi < st.ships.length; oi++) {
            var oe = st.ships[oi];
            if (!oe.alive || oe.slot === mySlot) continue;
            if (oe.x >= camL && oe.x <= camR && oe.y >= camT && oe.y <= camB) continue;
            var cx2 = camW / 2, cy2 = camH / 2;
            var dx2 = oe.x - (camL + cx2), dy2 = oe.y - (camT + cy2);
            var angle2 = Math.atan2(dy2, dx2);
            var hw2 = camW/2 - 40, hh2 = camH/2 - 40;
            var tanA = Math.abs(dy2 / (dx2 || 0.001));
            var ix2, iy2;
            if (tanA < hh2 / hw2) { ix2 = dx2 > 0 ? hw2 : -hw2; iy2 = ix2 * (dy2 / (dx2 || 0.001)); }
            else { iy2 = dy2 > 0 ? hh2 : -hh2; ix2 = iy2 * (dx2 / (dy2 || 0.001)); }
            var sx2 = cx2 + ix2 + camL, sy2 = cy2 + iy2 + camT;
            combatGraphics.fillStyle(oe.color, 0.9);
            var as2 = 10;
            combatGraphics.fillTriangle(
                sx2 + Math.cos(angle2)*as2, sy2 + Math.sin(angle2)*as2,
                sx2 + Math.cos(angle2+2.5)*as2, sy2 + Math.sin(angle2+2.5)*as2,
                sx2 + Math.cos(angle2-2.5)*as2, sy2 + Math.sin(angle2-2.5)*as2
            );
        }
    }
})();
</script>
</body>
</html>
